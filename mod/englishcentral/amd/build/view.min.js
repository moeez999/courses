/**
 * load the EnglishCentral player
 *
 * @module      mod_englishcentral/view
 * @category    output
 * @copyright   Gordon Bateson
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since       2.9
 */
define(["jquery","js/jquery-ui.js","core/log","core/str","mod_englishcentral/html"],(function($,JUI,LOG,STR,HTML){var VIEW={plugin:"mod_englishcentral",playercontainer:"id_playercontainer",progresscontainer:"id_progresscontainer",searchcontainer:"id_searchcontainer",searchpage:0,searchsize:20,searchterm:"",searchlevel:"",str:{}};return STR.get_strings([{key:"addthisvideo",component:VIEW.plugin},{key:"advanced",component:VIEW.plugin},{key:"beginner",component:VIEW.plugin},{key:"confirmremovevideo",component:VIEW.plugin},{key:"copyright",component:VIEW.plugin},{key:"description",component:VIEW.plugin},{key:"duration",component:"search"},{key:"error",component:"error"},{key:"goals",component:VIEW.plugin},{key:"hideadvanced",component:"form"},{key:"info",component:"moodle"},{key:"intermediate",component:VIEW.plugin},{key:"level",component:VIEW.plugin},{key:"ok",component:"moodle"},{key:"search",component:"moodle"},{key:"showadvanced",component:"form"},{key:"topics",component:VIEW.plugin},{key:"transcript",component:VIEW.plugin},{key:"videosearch",component:VIEW.plugin},{key:"videosearchhelp",component:VIEW.plugin},{key:"videosearchprompt",component:VIEW.plugin},{key:"videodetails",component:VIEW.plugin}]).done((function(s){var i=0;VIEW.str.addthisvideo=s[i++],VIEW.str.advanced=s[i++],VIEW.str.beginner=s[i++],VIEW.str.confirmremovevideo=s[i++],VIEW.str.copyright=s[i++],VIEW.str.description=s[i++],VIEW.str.duration=s[i++],VIEW.str.error=s[i++],VIEW.str.goals=s[i++],VIEW.str.hideadvanced=s[i++],VIEW.str.info=s[i++],VIEW.str.intermediate=s[i++],VIEW.str.level=s[i++],VIEW.str.ok=s[i++],VIEW.str.search=s[i++],VIEW.str.showadvanced=s[i++],VIEW.str.topics=s[i++],VIEW.str.transcript=s[i++],VIEW.str.videosearch=s[i++],VIEW.str.videosearchhelp=s[i++],VIEW.str.videosearchprompt=s[i++],VIEW.str.videodetails=s[i++]})),VIEW.init=function(opts){for(var i in opts)VIEW[i]=opts[i];VIEW.getoptions=$.Deferred(),$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,action:"getoptions",sesskey:VIEW.moodlesesskey},dataType:"json",success:function(opts){for(var i in opts)VIEW[i]=opts[i];VIEW.getoptions.resolve()}}),VIEW.ECSDK=$.Deferred(),$.when(VIEW.getoptions).done((function(){1==VIEW.sdkmode?VIEW.sdkurl="https://www.qaenglishcentral.com":VIEW.sdkurl="https://www.englishcentral.com","JSDK2"==VIEW.sdkversion?VIEW.sdkurl+="/partnersdk/sdk.js":VIEW.sdkurl+="/dist/sdk/sdk.js",$.ajax({url:VIEW.sdkurl,dataType:"script",cache:!0}).done((function(){VIEW.ECSDK.resolve(window.ECSDK)})),$(".activity-title").each((function(){var url=this.dataset.videoDetailsUrl;if(url){var src=$(".removevideo img").prop("src").replace("removevideo","i/info").replace("mod_englishcentral","core"),icon=HTML.emptytag("img",{src:src,class:"icon infoicon",title:VIEW.str.info});(icon=$(HTML.tag("a",icon,{href:url,style:"position: absolute;"}))).click((function(evt){return VIEW.open_window(this.href),evt.stopPropagation(),evt.preventDefault(),!1})),$(this).css({"margin-left":"0px"}).before(icon)}}))}));var thumbOutline=$(".activity-thumbnail").first().children(".thumb-outline"),videoPlaceholderVideo=$(".video-placeholder-video"),activityTitle=thumbOutline.children(".activity-title").text();$(".video-placeholder-text-title").text(activityTitle);var levelNumber=thumbOutline.find(".difficulty-level").text().slice(-1),videoPlaceholderTextLabel=$(".video-placeholder-text-label");videoPlaceholderTextLabel.text(levelNumber),1==levelNumber||2==levelNumber?videoPlaceholderTextLabel.addClass("label-green"):3==levelNumber||4==levelNumber?videoPlaceholderTextLabel.addClass("label-blue"):videoPlaceholderTextLabel.addClass("label-black");var difficultyLabel=thumbOutline.find(".difficulty-label").text(),videoPlaceholderTextLevel=$(".video-placeholder-text-level");videoPlaceholderTextLevel.text(difficultyLabel),1==levelNumber||2==levelNumber?videoPlaceholderTextLevel.addClass("level-green"):3==levelNumber||4==levelNumber?videoPlaceholderTextLevel.addClass("level-blue"):videoPlaceholderTextLevel.addClass("level-black");var activityDescription=thumbOutline.find(".thumb-frame").attr("description");$(".video-placeholder-text-description").text(activityDescription);var activityTopics=thumbOutline.find(".thumb-frame").attr("topics");$(".video-placeholder-text-tags").text(activityTopics);var activityImage=thumbOutline.children(".thumb-frame").attr("data-demopicurl"),activityVideoId=thumbOutline.children(".thumb-frame").attr("data-url"),$newImage=$("<img>");$newImage.attr("src",activityImage),$newImage.attr("data-url",activityVideoId),$newImage.attr("class","video-placeholder-video-image"),videoPlaceholderVideo.append($newImage),$(".video-placeholder-text-social").attr("data-url",activityVideoId),$(".video-placeholder-text-progress").attr("data-url",activityVideoId);var $bigPlayButton=$("<img>");$bigPlayButton.attr("src","pix/big-play-icon.svg"),$bigPlayButton.attr("data-url",activityVideoId),$bigPlayButton.attr("class","video-placeholder-video-big-play-button"),videoPlaceholderVideo.append($bigPlayButton),$(".activity-title, .thumb-frame, .video-placeholder-video-image, .video-placeholder-video-big-play-button, .video-placeholder-text-social, .video-placeholder-text-progress").click((function(evt){return VIEW.play_video(evt,this),$(".video-placeholder").hide(),$(".faux-loader").show(),$(".faux-loader").delay(2e3).fadeOut("slow"),evt.stopPropagation(),evt.preventDefault(),!1})),$(".englishcentral_videos").sortable({cursor:"grabbing",items:".activity-thumbnail",update:function(evt,ui){var url=ui.item.find(".activity-title").data("url"),data={dialogId:VIEW.get_videoid_from_url(url),sortorder:ui.item.index()+1};$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,data:data,action:"sortvideo",sesskey:VIEW.moodlesesskey},dataType:"html",success:function(html){html&&$("#"+VIEW.playercontainer).html(html)}})}}),$(".removevideo").droppable({drop:function(evt,ui){if(confirm(VIEW.str.confirmremovevideo)){ui.draggable.remove();var url=ui.draggable.find(".activity-title").data("url"),data={dialogId:VIEW.get_videoid_from_url(url)};$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,data:data,action:"removevideo",sesskey:VIEW.moodlesesskey},dataType:"html",success:function(html){html&&$("#"+VIEW.playercontainer).html(html)}})}}}),$("#"+VIEW.searchcontainer+" .search-form").submit((function(evt){VIEW.clear_searchresults();var list=new RegExp("^s*[0-9]+([, \\t\\r\\n]+[0-9]+)*s*$"),term=$("#id_searchterm").val(),level=$("[name='level[]']:checked").map((function(){return this.value})).get().join(",");""==term?$(".search-results").html(VIEW.str.videosearchhelp):term.match(list)?VIEW.fetch_videos(null,null,term,level):VIEW.search_videos(null,null,term,level),evt.preventDefault()})),$("#"+VIEW.searchcontainer+" .search-advanced").click((function(){$(this).text()==VIEW.str.showadvanced?$(this).text(VIEW.str.hideadvanced):$(this).text(VIEW.str.showadvanced),$("#"+VIEW.searchcontainer+" .search-fields").find("dt:not(.visible), dd:not(.visible)").toggle()}));var idSearchContainer=$("#id_searchcontainer"),fauxsearchButton=$("#faux-search-button"),closeSearchButton=$("#close-search-button"),searchBox=$(".search-box"),searchResults=$(".search-results");(fauxsearchButton||closeSearchButton)&&(fauxsearchButton.click((function(){searchBox.css("display","flex"),searchResults.css("display","flex"),idSearchContainer.css({width:"auto",height:"auto"}),fauxsearchButton.css("display","none"),closeSearchButton.css("display","flex")})),closeSearchButton.click((function(){searchBox.css("display","none"),searchResults.css("display","none"),idSearchContainer.css({width:"178px",height:"110px"}),fauxsearchButton.css("display","flex"),closeSearchButton.css("display","none")})))},VIEW.play_video=function(evt,elm){$.when(VIEW.ECSDK,evt,elm).done((function(ecsdk,evt,elm){VIEW.clear_player_and_searchresults();var setHandler="";ecsdk.setOnProgressEventHandler?setHandler="setOnProgressEventHandler":ecsdk.setOnModeEndHandler&&(setHandler="setOnModeEndHandler"),setHandler&&ecsdk[setHandler]((function(data){switch(LOG.debug(data),data.eventType){case"CompleteActivityWatch":case"LearnedWord":case"DialogLineSpeak":default:break;case"DialogLineWatch":var thumbframe=".thumb-frame[data-url$="+data.dialogID+"]";if($(thumbframe+" .watch-status").length)return!1;break;case"CompleteActivityLearn":case"CompleteActivitySpeak":case"StartActivityWatch":case"StartActivityLearn":case"TypedWord":case"StudiedWord":case"StartActivitySpeak":return!1}$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,data:{dialogID:data.dialogID,sdktoken:VIEW.sdktoken},action:"storeresults",sesskey:VIEW.moodlesesskey},dataType:"html"}).done((function(html){if(html.match(new RegExp("^\\{.*\\}$")))return html=html.replace(new RegExp("\\n","g"),"\\\\n"),html=(html=JSON.parse(html)).error?html.error.replace(new RegExp("\\n","g"),"<br>"):"Sorry, there was an unknown error on the server.\n"+(html=html.toString().substr(0,200)),VIEW.dialog?VIEW.dialog.dialog("isOpen")&&VIEW.dialog.dialog("close"):(VIEW.dialog=$("<div></div>").addClass("dialog"),VIEW.dialog.dialog({autoOpen:!1})),VIEW.dialog.html(html),VIEW.dialog.dialog("option","title",VIEW.str.error),VIEW.dialog.dialog("option","buttons",[{text:VIEW.str.ok,click:function(){$(this).dialog("close");var href=VIEW.viewajaxurl.replace(".ajax","");window.location.href=href+"?id="+VIEW.cmid}}]),VIEW.dialog.dialog("open"),!1;html.indexOf("englishcentral_progress")<0?$(".englishcentral_progress").html(html):$(".englishcentral_progress").replaceWith(html),$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,data:{dialogID:data.dialogID,sdktoken:VIEW.sdktoken},action:"showstatus",sesskey:VIEW.moodlesesskey},dataType:"html"}).done((function(html){var thumb=$(".thumb-frame[data-url$="+data.dialogID+"]");thumb.find(".watch-status, .learn-status, .speak-status").remove(),thumb.find(".play-icon").after(html)}))}))}));var dialogId=VIEW.get_videoid(elm),completed=".thumb-frame[data-url$="+dialogId+"] .watch-status.completed",options={partnerKey:VIEW.consumerkey,partnerSdkToken:VIEW.sdktoken,container:VIEW.playercontainer,dialogId:dialogId,settings:VIEW.settings};if("JSDK3"==VIEW.sdkversion)options.lang=VIEW.sitelanguage;else{options.siteLanguage=VIEW.sitelanguage,options.autoStart=$(completed).length,options.activityPanelEnabled=!1,options.interstitialsEnabled=!0,options.learnMode=!0,options.speakMode=!0,options.quizMode=!0,options.width=640;var w=window.outerWidth-$("#"+VIEW.playercontainer).offset().left-24;options.width>w?options.width=w:w>1e3?options.width=1e3:options.height=655}LOG.debug("options: "+JSON.stringify(options)),ecsdk.loadWidget("player",options)}))},VIEW.clear_searchresults=function(){$("#"+VIEW.searchcontainer+" .search-results").html("")},VIEW.clear_player_and_searchresults=function(){$("#"+VIEW.playercontainer).html(""),$("#"+VIEW.searchcontainer+" .search-results").html("")},VIEW.fetch_videos=function(page,size,term,level){var spacer=new RegExp("[, \\t\\r\\n]+","g"),ids=term.replace(spacer,",");VIEW.set_search_params(page,size,ids,level);var data={dialogIDs:ids,page:VIEW.searchpage,pageSize:VIEW.searchsize,siteLanguage:VIEW.siteanguage};$.ajax({url:VIEW.fetchurl,type:"GET",data:data,dataType:"json",headers:{Accept:VIEW.accept1,Authorization:VIEW.authorization,"Content-Type":"application/json"},success:function(dialogs){var info=!1;if(dialogs&&dialogs.length>0){info={count:dialogs.length,results:[]};for(var i=0;i<dialogs.length;i++){var highlights={};highlights.en_name=["<em>"+dialogs[i].title+"</em>"],highlights.en_topic=["<em>"+dialogs[i].topics[0].name+"</em>"],highlights.en_description=[dialogs[i].description],info.results.push({score:150,value:dialogs[i],highlights:highlights})}}VIEW.format_results(info)}})},VIEW.search_videos=function(page,size,term,level){VIEW.set_search_params(page,size,term,level);var data={term:VIEW.searchterm,page:VIEW.searchpage,pageSize:VIEW.searchsize};level&&(data.difficulty=level),VIEW.searchterm&&$.ajax({url:VIEW.searchurl,type:"GET",data:data,dataType:"json",headers:{Accept:VIEW.accept1,Authorization:VIEW.authorization,"Content-Type":"application/json"},success:function(info){VIEW.format_results(info)}})},VIEW.set_search_params=function(page,size,term,level){VIEW.isNotNum(page)?(VIEW.searchpage=0,VIEW.searchterm="",VIEW.searchlevel=""):VIEW.searchpage=parseInt(page),size&&(VIEW.searchsize=parseInt(size)),term&&(VIEW.searchterm=term),level&&(VIEW.searchlevel=level)},VIEW.format_results=function(info){var html="";if(!info||!info.results||0==info.results.length)return html;for(var pagingbar=VIEW.pagingbar(info.count),videoids=VIEW.get_videoids(),i=0;i<info.results.length;i++){var id=info.results[i].value.dialogID.toString();videoids.indexOf(id)<0&&(html+=VIEW.format_result(info.results[i]))}html+=pagingbar,$(".search-results").html(html),STR.get_string("xitemsfound",VIEW.plugin,VIEW.formatnumber(info.count)).done((function(s){$(".search-results").prepend(HTML.tag("div",s,{class:"itemsfound"}))}));for(i=0;i<info.results.length;i++){var v=info.results[i].value,data={dialogId:v.dialogID,title:v.title,duration:v.duration,difficulty:v.difficulty,dialogURL:v.dialogURL,thumbnailURL:v.thumbnailURL,description:v.description,topics:JSON.stringify(v.topics)};$(id="#id_add_video_"+data.dialogId).data(data),$(id).parent().click((function(evt){$(evt.target).closest(".result-info").length||VIEW.add_video(evt,this)})),$(id).siblings(".result-thumb").click((function(){})),$(id).siblings(".result-info").find(".video-info").click((function(){var id=$(this).closest(".result-info").siblings(".result-add").prop("id");VIEW.open_window(VIEW.videoinfourl+"/"+VIEW.get_videoid_from_id(id))}))}$(".pagingbar").find(".pagenumber:not(.currentpage)").click((function(){var page=$(this).text()-1;VIEW.search_videos(page)}))},VIEW.get_videoids=function(){var videoids=[];return $(".englishcentral_videos .activity-title").each((function(){videoids.push(VIEW.get_videoid(this))})),videoids},VIEW.get_videoid=function(elm){var url=$(elm).data("url");return VIEW.get_videoid_from_url(url)},VIEW.get_videoid_from_url=function(url){return url.replace(new RegExp("^.*/"),"")},VIEW.get_videoid_from_id=function(id){return id.replace(new RegExp("^.*_"),"")},VIEW.open_window=function(url){var w=Math.min(640,window.innerWidth),h=Math.min(480,window.innerHeight),x=window.outerWidth/2+window.screenX-w/2,options="width="+w+",height="+h+",top="+(window.outerHeight/2+window.screenY-h/2)+",left="+x,win=window.open(url,VIEW.targetwindow,options);win.focus&&win.focus()},VIEW.pagingbar=function(count){var html="";if(count){var size=VIEW.searchsize,lastpage=Math.ceil(count/size)-1;if(lastpage>0){var page=VIEW.searchpage,p_min=Math.max(0,VIEW.searchpage-4),p_max=Math.min(lastpage,Math.max(9,VIEW.searchpage+4));0<p_min&&(html+=HTML.tag("span",1,{class:"pagenumber"}),p_min-0>1&&(html+=HTML.tag("span","...",{class:"pageseparator"})));for(var p=p_min;p<=p_max;p++){var s="pagenumber";p==page&&(s+=" currentpage"),html+=HTML.tag("span",p+1,{class:s})}p_max<lastpage&&(lastpage-p_max>1&&(html+=HTML.tag("span","...",{class:"pageseparator"})),html+=HTML.tag("span",lastpage+1,{class:"pagenumber"}))}}return html&&(html=HTML.tag("div",html,{class:"pagingbar"})),html},VIEW.formatnumber=function(n,separator){void 0===separator&&(separator=","),"number"==typeof n&&(n=n.toString());var regexp=new RegExp("\\B(?=(\\d{3})+(?!\\d))","g");return n.replace(regexp,separator)},VIEW.add_video=function(evt,elm){$.ajax({url:VIEW.viewajaxurl,type:"POST",data:{id:VIEW.cmid,data:$(elm).children(":first").data(),action:"addvideo",sesskey:VIEW.moodlesesskey},dataType:"html",success:function(html){$(html).insertBefore(".removevideo").find(".thumb-frame").click((function(evt){return VIEW.play_video(evt,this),$(".video-placeholder").hide(),$(".faux-loader").show(),$(".faux-loader").delay(2e3).fadeOut("slow"),evt.stopPropagation(),evt.preventDefault(),!1})),$(".videoicon.removevideo").removeClass("page-mod-englishcentral-hide"),$(".player-container-class").removeClass("page-mod-englishcentral-hide")}}),$(elm).closest(".result-item").fadeTo(1e3,.01,(function(){$(this).slideUp(150,(function(){$(this).remove()}))}))},VIEW.format_result=function(r){if(VIEW.isNotNum(r.value.difficulty)||r.value.difficulty<1||r.value.difficulty>7)r.value.difficulty=0,r.difficulty="unknown";else switch(!0){case r.value.difficulty<=2:r.difficulty="beginner";break;case r.value.difficulty<=4:r.difficulty="intermediate";break;case r.value.difficulty<=7:r.difficulty="advanced"}var html="";return html+=VIEW.format_add(r),html+=VIEW.format_thumb(r),html+=VIEW.format_info(r),HTML.tag("div",html,{class:"result-item"})},VIEW.format_add=function(r){var src=$(".removevideo img").prop("src").replace("removevideo","add"),html=HTML.emptytag("img",{src:src,title:VIEW.str.addthisvideo});return HTML.tag("div",html,{class:"result-add",id:"id_add_video_"+r.value.dialogID})},VIEW.format_thumb=function(r){var duration=r.value.duration.replace(new RegExp("^00:"),""),html="";return html+=HTML.starttag("div",{class:"thumb-frame",style:"background-image: url('"+r.value.thumbnailURL+"')"}),html+=HTML.tag("div",r.value.difficulty,{class:"result-difficulty "+r.difficulty}),html+=HTML.tag("div",duration,{class:"result-duration"}),html+=HTML.endtag("div"),HTML.tag("div",html,{class:"result-thumb","data-url":r.value.dialogURL})},VIEW.format_info=function(r){var html="",src=$(".removevideo img").prop("src").replace("removevideo","i/info").replace("mod_englishcentral","core"),title=r.value.title;return r.highlights.en_name&&(title=r.highlights.en_name[0]),html+=HTML.tag("h2",title,{class:"result-title"}),html+=HTML.tag("div","",{src:src,class:"video-info","data-toggle":"tooltip","data-placement":"left",title:VIEW.str.videodetails}),html+=VIEW.format_details(r),HTML.tag("div",html,{class:"result-info"})},VIEW.format_details=function(r){var html="";return html+=VIEW.format_goalstopics(r.value.goals,r.value.topics,r.difficulty),html+=VIEW.format_description(r.value.description),html+=VIEW.format_transcript(r.highlights.transcript),HTML.tag("dl",html,{class:"result-details"})},VIEW.format_copyright=function(copyright){return copyright&&copyright.length?VIEW.format_detail("copyright",copyright):""},VIEW.format_goalstopics=function(goals,topics,difficulty){var txt=[];if(goals&&goals.length)for(var i=0;i<goals.length;i++)txt.push(goals[i].title);if(topics&&topics.length)for(i=0;i<topics.length;i++)txt.push(topics[i].name);return 0==txt.length?"":(txt=txt.join(", "),txt+=HTML.tag("span",VIEW.str[difficulty],{class:"result-level "+difficulty}),VIEW.format_detail("topics",txt))},VIEW.format_description=function(description){return description&&description.length?VIEW.format_detail("description",description):""},VIEW.format_transcript=function(transcript){if(transcript&&transcript.length){var slashes=new RegExp("//","g");return VIEW.format_detail("transcript","..."+transcript[0].replace(slashes,"...")+"...")}return""},VIEW.format_detail=function(type,value){var html="";return html+=HTML.tag("dt",VIEW.str[type],{class:"result-label "+type}),html+=HTML.tag("dd",value,{class:"result-value "+type})},VIEW.isNotNum=function(n){switch(typeof n){case"number":return!1;case"string":return!n.match(new RegExp("^[0-9]+$"));default:return!0}},VIEW}));

//# sourceMappingURL=view.min.js.map