YUI.add("moodle-atto_subtitle-button",function(e,t){var n="atto_subtitle",r="subtitle",i={LINK:"link",MEDIA:"media"},s={LINK:"link",VIDEO:"video",AUDIO:"audio"},o={VIDEO:"atto_subtitle_video",AUDIO:"atto_subtitle_audio",UPLOAD:"atto_subtitle_upload",SUBTITLE:"atto_subtitle_subtitle",SUBTITLE_CHECKBOX:"atto_subtitle_subtitle_checkbox",MEDIAINSERT_CHECKBOX:"atto_subtitle_mediainsert_checkbox",ATTO_CLOUDPOODLL_FORM:"atto_subtitle_form",CP_VIDEO:"atto_subtitle_video_cont",CP_AUDIO:"atto_subtitle_audio_cont",CP_UPLOAD:"atto_subtitle_upload_cont",CP_SWAP:"atto_subtitle_swapmeout"},u={subtitling:!1,selectednode:!1,selectednodetype:!1,mediaurl:[],fullurl:!1},a={HTML_MEDIA:{VIDEO:'&nbsp;<video &nbsp;<audio controls="true" crossorigin="anonymous"><source src="{{url}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">{{/if}}</video>&nbsp;',AUDIO:'&nbsp;<audio controls="true" crossorigin="anonymous"><source src="{{url}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">{{/if}}</audio>&nbsp;',LINK:'&nbsp;<a href="{{url}}" {{#if issubtitling}} data-subtitles="{{subtitleurl}}" data-language="{{language}}" {{/if}}>{{name}}</a>&nbsp;'},CAPTIONTRACK:'<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">'};e.namespace("M.atto_subtitle").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(e){e.disabled||this.addButton({icon:r,iconComponent:n,title:"subtitle",buttonName:r,callback:this._displayDialogue,callbackArgs:null,tags:"a,video,audio",tagMatchRequiresAll:!1}),a.ROOT=e.templates_root,a.DIALOG=e.templates_dialog},_getContext:function(t){return e.merge({elementid:this.get("host").get("elementid"),imgpath:M.cfg.wwwroot+"/lib/editor/atto/plugins/subtitle/pix/e/",component:n,helpStrings:this.get("help"),CSS:o},t)},_displayDialogue:function(t,i){if(this.get("host").getSelection()===!1)return;var s=this.get("host").getSelectedNodes().filter("video,audio,a");if(!s||s.size()==0){var o=this.get("host").getSelectionParentNode();if(!o)return;anchornodes=this._findSelectedAnchors(e.one(o));if(anchornodes.length==0)return}var a=M.util.get_string("subtitle",n),f="1200px",l={};l.headerContent=a,l.focusAfterHide=r,l.width=f;var c=this.getDialogue(l);c.set("bodyContent",this._getDialogueContent()).show(),u.elementid=this.get("host").get("elementid");var h=this;this._loadSubtitleEditor()},_loadSubtitleEditor:function(){var e=this,t=this.get("host");e.uploaded=!1;var r=t.getSelectedNodes().filter("video,audio").shift();if(r){var o=this._fetchSelectedURLs_mediatag(r);u.selectednode=r,u.selectednodetype=i.MEDIA}else{u.selectednodetype=i.LINK;var o=this._fetchSelectedURLs_anchor()}u.mediaurl=o.mediaurl,u.fullurl=o.fullurl;var a=function(t,r){switch(t){case"upload-ended":var i=!1,s=window.JSON.parse(r);s&&("url"in s?i=s.url:"newfile"in s&&(i=s.newfile.url)),i?e._updateAndClose(i):(alert(M.util.get_string("uploadproblem",n)),e.loader.do_download());break;case"remove-subtitles":e._removeAndClose(!1);break;default:}},f=r?this._getMediumProperties(r):!1,l=s.VIDEO;f&&(l=f.type),require(["atto_subtitle/loader"],function(n){e.loader=n,n.init(t,a,o,l)})},_fetchSelectedURLs_mediatag:function(e){var t={mediaurl:[],vtturl:!1,fullurl:!1},n=e?this._getMediumProperties(e):!1;return n&&(n.sources&&n.sources.length>0?t.mediaurl=n.sources:t.mediaurl[0]=n.src,t.fullurl=t.mediaurl[0],n.tracks&&"captions"in n.tracks&&n.tracks.captions.length>0&&(t.vtturl=n.tracks.captions[0].src)),t},_getMediumProperties:function(e){var t=function(e,t){return e.getAttribute(t)?!0:!1},n={subtitles:[],captions:[],descriptions:[],chapters:[],metadata:[]};return e.all("track").each(function(e){n[e.getAttribute("kind")].push({src:e.getAttribute("src"),srclang:e.getAttribute("srclang"),label:e.getAttribute("label"),defaultTrack:t(e,"default")})}),{type:e.test("video")?s.VIDEO:s.AUDIO,sources:e.all("source").get("src"),src:e.getAttribute("src"),poster:e.getAttribute("poster"),width:e.getAttribute("width"),height:e.getAttribute("height"),autoplay:t(e,"autoplay"),loop:t(e,"loop"),muted:t(e,"muted"),controls:t(e,"controls"),tracks:n}},_fetchSelectedURLs_anchor:function(){var t=this.get("host").getSelectionParentNode(),n=null,r=null,i={mediaurl:[],vtturl:!1,fullurl:!1};if(!t)return i;n=this._findSelectedAnchors(e.one(t));if(n.length>0){r=n[0],u.selectednode=r,i.fullurl=r.getAttribute("href"),i.mediaurl[0]=i.fullurl;if(i.fullurl!=""){var s=new URL(i.fullurl),o=new URLSearchParams(s.search);o&&(i.vtturl=o.get("data-subtitles"),i.mediaurl[0]=i.fullurl.replace(s.search,""))}}return i},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(t){var n=e.Node.create(e.Handlebars.compile(a.ROOT+a.DIALOG)(this._getContext()));return n},_removeAndClose:function(e){var t=!1;if(u.selectednodetype===i.MEDIA)u.selectednode.all("track").each(function(e){e.getAttribute("kind")=="captions"&&!t&&(e.setAttribute("src",""),t=!0)});else{var n=new URL(u.fullurl),r="",s=new URLSearchParams(n.search);s?(s.delete("data-subtitles"),r=s.toString()):r="",r=decodeURIComponent(r),n.search=r,u.selectednode.setAttribute("href",n.href),t=!0}this.getDialogue({focusAfterHide:null}).hide(),this.markUpdated()},_updateAndClose:function(t){var n=!1;if(u.selectednodetype==i.MEDIA){u.selectednode.all("track").each(function(e){e.getAttribute("kind")=="captions"&&!n&&(e.setAttribute("src",t),n=!0)});if(!n){var r={};r.subtitleurl=t,r.language="captions";var s=e.Node.create(e.Handlebars.compile(a.CAPTIONTRACK)(r));u.selectednode.append(s)}}else{var o=new URL(u.fullurl),f="",l=new URLSearchParams(o.search);l?(l.set("data-subtitles",t),f=l.toString()):f="?data-subtitles="+t,f=decodeURIComponent
(f),o.search=f,u.selectednode.setAttribute("href",o.href),n=!0}this.getDialogue({focusAfterHide:null}).hide(),this.markUpdated()}},{ATTRS:{disabled:{value:!1}}})},"@VERSION@");
